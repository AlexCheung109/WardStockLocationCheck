<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ward Stock System</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Include QRious Library for QR Code Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- Include ZXing Library -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
.result-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
    max-width: 400px;
    margin: 20px auto;
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.qr-code-section {
    background-color: #fff;
    padding: 20px;
    display: flex;
    flex-direction: column; /* 垂直排列，確保提示文字在上方 */
    align-items: center;
    justify-content: center;
    width: 100%;
    border-bottom: 1px solid #ddd;
}

.qr-code-section canvas {
    width: 150px;
    height: 150px;
}
.animate-spin {
    animation: spin 1s linear infinite;
}

.qr-reminder {
    font-size: 14px;
    color: #333;
    text-align: center;
    margin-bottom: 10px; /* 與二維碼之間的間距 */
}

.text-result-section {
    width: 100%;
    word-wrap: break-word;
}

.text-result-section p {
    font-size: 14px;
    margin: 10px 0;
}

.text-result-section.error {
    color: #f44336; /* 紅色 */
    font-weight: bold; /* 粗體 */
    text-align: center; /* 置中 */
    font-size: 16px;
}
.text-result-section .highlight {
    font-weight: bold;
    color: #4CAF50;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.required {
    color: red;
    margin-left: 4px;
}

select:disabled,
input:disabled {
    background-color: #f5f5f5;
    cursor: not-allowed;
}

button:disabled {
    background-color: #cccccc !important;
    cursor: not-allowed;
    opacity: 0.7;
}

.search-group label {
    font-weight: bold;
}


input:disabled {
    background-color: #f5f5f5;
    cursor: not-allowed;
}

button:disabled {
    background-color: #cccccc !important;
    cursor: not-allowed;
    opacity: 0.7;
}
.scanner-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    height: 60%;
    border: 3px dashed #4CAF50;
    border-radius: 10px;
    z-index: 2;
    background: rgba(255, 255, 255, 0.1);
}

.overlay-mask {
    position: absolute;
    background: rgba(0, 0, 0, 0.5);
}

.overlay-top {
    top: 0;
    left: 0;
    right: 0;
    height: calc(50% - 60px); /* 調整高度以配合掃描框 */
}

.overlay-bottom {
    bottom: 0;
    left: 0;
    right: 0;
    height: calc(50% - 60px);
}

.overlay-left {
    top: calc(50% - 60px);
    left: 0;
    width: calc(50% - 120px);
    height: 120px;
}

.overlay-right {
    top: calc(50% - 60px);
    right: 0;
    width: calc(50% - 120px);
    height: 120px;
}



        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .banner {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .banner-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        .search-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        select, input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #result, #cupboardResult, #dutyQueryResult, .wardDropdown {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            word-break: break-word;
        }
        #loading, #cupboardLoading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .location-text {
            font-weight: bold;
            font-size: 180%;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping if needed */
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #ddd;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
            white-space: nowrap;
            text-align: center;
        }
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .ward-title {
            font-size: 150%;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .location-label {
            font-weight: normal;
            margin-top: 15px;
            margin-bottom: 5px;
        }
        .location-value {
            font-size: 150%;
            font-weight: bold;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        .update-info {
            font-style: italic;
            color: #666;
            margin-bottom: 15px;
        }
        .item-description {
            white-space: normal;
            word-wrap: break-word;
            overflow: visible;
            text-overflow: unset;
            max-width: 100%;
            display: block;
            line-height: 1.4;
            margin-bottom: 10px;
            font-size: 50%; /* Reduced font size by half */
        }
        #scheduleImages img {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            width: 100%;
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;
        }
        #dataCaptureScheduleTab {
            text-align: center;
        }
        #dataCaptureScheduleTab h1 {
            text-align: left;
        }
        .result-item {
            margin-bottom: 15px;
        }
        /* QR Code Container Style */
        .qr-code {
            margin-top: 20px;
            text-align: center;
        }
        /* Description Text Style */
        .qr-description {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
.search-input-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.scan-button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.scan-button:hover {
    background-color: #45a049;
}
.scanner-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    overflow: auto; /* 添加滾動條以適應長內容 */
    background-color: rgba(0, 0, 0, 0.7); /* 背景半透明 */
}

.scanner-content {
    position: relative;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    max-height: 90%; /* 限制內容高度 */
    overflow-y: auto; /* 如果內容超長，啟用滾動條 */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
.scan-result-content {
    text-align: left;
    width: 100%;
}

.scan-result-content div {
    margin-bottom: 8px;
}

.scan-result-location {
    font-weight: bold;
    color: #4CAF50;
}

.scan-result-description {
    font-size: 0.9em;
    color: #666;
}

.scan-result-display {
    background-color: white;
    padding: 15px;
    margin-top: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 3;
    min-height: 200px; /* 確保有足夠空間 */
    display: flex;
    flex-direction: column;
    align-items: center;
}
.scanner-header {
    background: transparent;
    color: white;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 3;
}

.close-button:hover {
    background: #ff0000;
}

#scanner-container {
    position: relative;
    width: 100%;
    height: 300px;
    margin-bottom: 10px;
    overflow: hidden;
}

#scanner-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
}
        /* Item Code Text Style */
        .item-code {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        /* New Styles for Data Capture Schedule Tab */
        .schedule-buttons {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column; /* Vertical alignment */
            gap: 10px; /* Space between buttons */
        }
        .hidden {
            display: none;
        }
        /* Duty Query Form Styles */
        .duty-query-form {
            background-color: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 20px;
        }
        .duty-query-form label {
            margin-top: 10px;
        }
        /* Styles for Accordion */
        details {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
        }
        summary {
            font-weight: bold;
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }
        /* Hide default markers */
        summary::-webkit-details-marker {
            display: none;
        }
        summary::marker {
            display: none;
        }
        summary::after {
            content: "▼";
            position: absolute;
            right: 0;
            top: 0;
            transition: transform 0.2s;
        }
        details[open] summary::after {
            transform: rotate(-180deg);
        }
        /* Accordion Dropdown Styles */
        .wardDropdown {
            margin-top: 10px;
        }
        /* Responsive Tabs: Switch to vertical on small screens */
        @media (max-width: 600px) {
            .tabs {
                flex-direction: column;
            }
            .tab-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="banner">
        <h1 class="banner-title">Top-up Location Helper</h1>
    </div>
    
    <div class="tabs">
        <button class="tab-button active" onclick="switchTab('binShelve', this)">Ward Stock Item Bin Shelve</button>
        <button class="tab-button" onclick="switchTab('cupboard', this)">Ward Stock Cupboard</button>
        <button class="tab-button" onclick="switchTab('dataCaptureSchedule', this)">Data Capture Schedule</button>
    </div>

    <!-- Bin Shelve Tab -->
    <div id="binShelveTab" class="tab-content active container">
        <h1>Ward Stock Item Bin Shelve Checker</h1>
        <div id="binShelveUpdateInfo" class="update-info"></div>
        <div id="productIdUpdateInfo" class="update-info"></div>
        <div id="itemPhqUpdateInfo" class="update-info"></div>
        
        <div id="loading">Loading...</div>
        <div id="error" class="error"></div>

<div class="search-group">
    <label for="wardSelect">Ward: <span class="required">*</span></label>
    <select id="wardSelect">
        <option value="">Please select a ward</option>
    </select>
</div>

<!-- Item Code Filter -->
<div class="search-group">
    <label for="itemCodeFilter">Filter by Item Code:</label>
    <div class="search-input-group">
        <input type="text" 
               id="itemCodeFilter" 
               placeholder="Please select a ward first" 
               disabled 
               oninput="filterItemCodes()">
        <button id="scanButton" 
                class="scan-button" 
                onclick="startScanner()" 
                disabled>
            Scan Barcode
        </button>
    </div>
</div>

<!-- Scanner Modal -->
<div id="scannerModal" class="scanner-modal">
    <div class="scanner-content">
        <!-- Close Button -->
        <button class="close-button" onclick="closeScanner()">&times;</button>

        <!-- Scanner Video -->
        <div id="scanner-container">
            <video id="scanner-video" playsinline></video>
            <!-- 遮罩層 -->
            <div class="overlay-mask overlay-top"></div>
            <div class="overlay-mask overlay-bottom"></div>
            <div class="overlay-mask overlay-left"></div>
            <div class="overlay-mask overlay-right"></div>
            <!-- 掃描框 -->
            <div class="scanner-overlay"></div>
        </div>

        <!-- 掃描結果區域 -->
        <div class="scan-result-display" style="display: none;">
            <div class="scan-result-content"></div>
        </div>
    </div>
</div>
        <!-- Removed the Item Code Select and Search Button -->
        <!-- The item codes will be displayed automatically upon ward selection -->

        <div id="result"></div>
        <!-- QR Code Container -->
        <div id="qrCodeContainer" class="qr-code"></div>
    </div>

    <!-- Cupboard Tab -->
    <div id="cupboardTab" class="tab-content container">
        <h1>Ward Stock Cupboard Location</h1>
        <div id="cupboardUpdateInfo" class="update-info"></div>

        <div id="cupboardLoading">Loading...</div>
        <div id="cupboardError" class="error"></div>

        <div class="search-group">
            <label for="cupboardWardSelect">Ward:</label>
            <select id="cupboardWardSelect" onchange="searchCupboard()">
                <option value="">Please select a ward</option>
            </select>
        </div>

        <div id="cupboardResult"></div>
    </div>

    <!-- Data Capture Schedule Tab -->
    <div id="dataCaptureScheduleTab" class="tab-content container">
        <h1>Data Capture Schedule</h1>
        <div id="dataCaptureUpdateInfo" class="update-info"></div>
        <div class="schedule-buttons">
            <button onclick="showFullSchedule()">View Full Data Capture Schedule</button>
            <button onclick="showDutyQuery()">Inquire According to Duty</button>
        </div>
        <!-- Full Schedule Section -->
        <div id="fullSchedule" class="hidden">
            <div id="scheduleImages" style="display: flex; flex-direction: column; gap: 20px;">
                <img id="schedule1" src="https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Top_up_schedule_p1.png" alt="Top-up Schedule Page 1">
                <img id="schedule2" src="https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Top_up_schedule_p2.png" alt="Top-up Schedule Page 2">
            </div>
        </div>
        <!-- Duty Query Section -->
        <div id="dutyQuery" class="hidden">
            <div class="duty-query-form">
                <h2>Inquire According to Duty</h2>
                <div class="search-group">
                    <label for="dutySelect">Duty:</label>
                    <select id="dutySelect">
                        <option value="">Please select a duty</option>
                        <option value="TP1-4">TP1-4</option>
                        <option value="I11">I11</option>
                        <option value="EA(I9)">EA(I9)</option>
                        <option value="P4(Main Store Member)">P4(Main Store Member)</option>
                    </select>
                </div>
                <div class="search-group">
                    <label for="weekdaySelect">Weekday:</label>
                    <select id="weekdaySelect">
                        <option value="">Please select a weekday</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                    </select>
                </div>
                <!-- Hidden Scanner Group -->
                <div class="search-group hidden scanner-group">
                    <label for="scannerTextbox">Scanner:</label>
                    <input type="text" id="scannerTextbox" readonly>
                </div>
                <button onclick="performDutySearch()">Search</button>
                <div id="dutyQueryResult"></div>
            </div>
        </div>
    </div>
<script>
    let data = [];
    let wards = new Set();
    let cupboardData = [];
    let cupboardWards = new Set();
    let itemDescriptions = new Map();
    let productIdMap = new Map();
    let scanning = false;

    // Mapping for Duty and Weekday to Scanner
    const dutyWeekdayScannerMap = {
        "TP1-4": {
            "Monday": "Scanner L",
            "Tuesday": "Scanner M",
            "Wednesday": "",
            "Thursday": "Scanner M",
            "Friday": "Scanner M"
        },
        "I11": {
            "Monday": "Scanner N",
            "Tuesday": "Scanner L",
            "Wednesday": "Scanner L",
            "Thursday": "Scanner L",
            "Friday": "Scanner O"
        },
        "EA(I9)": {
            "Monday": "",
            "Tuesday": "",
            "Wednesday": "",
            "Thursday": "Scanner O",
            "Friday": "Scanner L"
        },
        "P4(Main Store Member)": {
            "Monday": "Scanner M",
            "Tuesday": "Scanner N",
            "Wednesday": "",
            "Thursday": "Scanner N",
            "Friday": "Scanner N"
        }
    };

    // Initialize Web Worker
    const worker = new Worker('https://AlexCheung109.github.io/WardStockLocationCheck/worker.js');

    async function getFileLastUpdateDate(filename) {
        try {
            const response = await fetch(`https://api.github.com/repos/AlexCheung109/WardStockLocationCheck/commits?path=${filename}&page=1&per_page=1`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const dataResponse = await response.json();
            if (dataResponse.length > 0) {
                const date = new Date(dataResponse[0].commit.committer.date);
                return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
            }
            return 'Date not available';
        } catch (error) {
            console.error('Error fetching file update date:', error);
            return 'Date not available';
        }
    }

    async function loadItemDescriptions() {
        try {
            const excelUrl = 'https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/item_phq.xlsx';
            const response = await fetch(excelUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const itemData = XLSX.utils.sheet_to_json(worksheet, {
                header: ['itemCode', 'description'],
                range: 0
            });
            itemDescriptions = new Map(
                itemData.map(row => [row.itemCode.toString(), shortenDescription(row.description)])
            );
        } catch (error) {
            console.error('Error loading item descriptions:', error);
            document.getElementById('error').textContent = 'Error loading item descriptions: ' + error.message;
        }
    }

    function shortenDescription(description) {
        if (!description) return 'No description available';
        if (description.length <= 50) return description;
        return description.substring(0, 50) + '...';
    }

    window.onload = async function() {
        try {
            if (!window.ZXing) {
                console.error('ZXing library not loaded');
            }

            const locationDate = await getFileLastUpdateDate('Location.xlsx');
            const cupboardDate = await getFileLastUpdateDate('WardStockCupboard.xlsx');
            const itemPhqDate = await getFileLastUpdateDate('item_phq.xlsx');
            const dataCaptureDate = await getFileLastUpdateDate('Top_up_schedule_p1.png');
            const productIdDate = await getFileLastUpdateDate('product_id.xlsx');
            
            document.getElementById('binShelveUpdateInfo').textContent = 
                `Bin shelve information last updated on: ${locationDate}`;
            document.getElementById('cupboardUpdateInfo').textContent = 
                `Ward Stock Cupboard information last updated on: ${cupboardDate}`;
            document.getElementById('itemPhqUpdateInfo').textContent = 
                `Item_phq.xlsx last updated on: ${itemPhqDate}`;
            document.getElementById('dataCaptureUpdateInfo').textContent = 
                `Data Capture last updated on: ${dataCaptureDate}`;
            document.getElementById('productIdUpdateInfo').textContent = 
                `Product ID mapping last updated on: ${productIdDate}`;

            await Promise.all([
                loadDataFromGitHub(),
                loadCupboardDataFromGitHub(),
                loadItemDescriptions(),
                loadProductIds(),
                autoSelectWeekday()
            ]);

            console.log('Initialization completed');
            console.log('ZXing available:', !!window.ZXing);
            console.log('ProductID map size:', productIdMap.size);

        } catch (error) {
            console.error('Initialization error:', error);
            document.getElementById('error').textContent = 
                'Error during initialization: ' + error.message;
        }
    };

    function switchTab(tabId, button) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });

        document.getElementById(tabId + 'Tab').classList.add('active');
        button.classList.add('active');
    }

    async function loadProductIds() {
        try {
            const excelUrl = 'https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Product_ID.xlsx';
            const response = await fetch(excelUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            const productData = XLSX.utils.sheet_to_json(worksheet, {
                header: ['itemCode', 'productId'],
                range: 1
            });

            productIdMap.clear();
            productData.forEach(row => {
                if (row.productId && row.itemCode) {
                    const productId = row.productId.toString().trim();
                    const itemCode = row.itemCode.toString().trim();
                    productIdMap.set(productId, itemCode);
                }
            });
            
        } catch (error) {
            alert('載入產品對照表時發生錯誤');
        }
    }

    function normalizeBarcode(text) {
        return text.toString().trim().toUpperCase();
    }

    async function loadDataFromGitHub() {
        const loading = document.getElementById('loading');
        loading.style.display = 'block';

        try {
            const excelUrl = 'https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Location.xlsx';
            const response = await fetch(excelUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            data = XLSX.utils.sheet_to_json(worksheet, {
                header: ['ward', 'itemCode', 'c', 'd', 'e', 'f', 'location'],
                range: 1
            });

            data = data.map(row => ({
                ward: row.ward,
                itemCode: row.itemCode,
                location: row.location
            }));

            wards = new Set(data.map(row => row.ward));
            updateWardSelect();
            
            loading.style.display = 'none';
        } catch (error) {
            console.error('Error loading data:', error);
            loading.style.display = 'none';
            document.getElementById('error').textContent = 'Error loading data: ' + error.message;
        }
    }

    async function loadCupboardDataFromGitHub() {
        const loading = document.getElementById('cupboardLoading');
        loading.style.display = 'block';

        try {
            const excelUrl = 'https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/WardStockCupboard.xlsx';
            const response = await fetch(excelUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            cupboardData = XLSX.utils.sheet_to_json(worksheet, {
                header: ['ward', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'ignore1', 'wardStockCupboardLocation', 'fridgeLocation', 'concentratedElectrolyteCupboardLocation', 'remark'],
                range: 1
            });

            cupboardData = cupboardData.map(row => ({
                ward: row.ward ? row.ward.toString().trim() : '',
                MON: row.MON ? row.MON.toString().trim() : '',
                TUE: row.TUE ? row.TUE.toString().trim() : '',
                WED: row.WED ? row.WED.toString().trim() : '',
                THU: row.THU ? row.THU.toString().trim() : '',
                FRI: row.FRI ? row.FRI.toString().trim() : '',
                wardStockCupboardLocation: row.wardStockCupboardLocation ? row.wardStockCupboardLocation.toString().trim() : '',
                fridgeLocation: row.fridgeLocation ? row.fridgeLocation.toString().trim() : '',
                concentratedElectrolyteCupboardLocation: row.concentratedElectrolyteCupboardLocation ? row.concentratedElectrolyteCupboardLocation.toString().trim() : '',
                remark: row.remark ? row.remark.toString().trim() : ''
            }));

            cupboardWards = new Set(cupboardData.map(row => row.ward));
            updateCupboardWardSelect();
            
            loading.style.display = 'none';
        } catch (error) {
            console.error('Error loading cupboard data:', error);
            loading.style.display = 'none';
            document.getElementById('cupboardError').textContent = 'Error loading cupboard data: ' + error.message;
        }
    }

    function updateCupboardWardSelect() {
        const select = document.getElementById('cupboardWardSelect');
        select.innerHTML = '<option value="">Please select a ward</option>';
        
        Array.from(cupboardWards).sort(sortWardsDesc).forEach(ward => {
            const option = document.createElement('option');
            option.value = ward;
            option.textContent = ward;
            select.appendChild(option);
        });
    }

    function searchCupboard() {
        const selectedWard = document.getElementById('cupboardWardSelect').value;
        const resultDiv = document.getElementById('cupboardResult');

        if (!selectedWard) {
            resultDiv.innerHTML = 'Please select a ward';
            return;
        }

        const found = cupboardData.find(row => row.ward === selectedWard);

        if (found) {
            let resultHTML = `
                <p class="ward-title">Ward: ${found.ward}</p>
                <p class="location-label">Ward Stock Cupboard Location:</p>
                <p class="location-value">${found.wardStockCupboardLocation || 'N/A'}</p>
                <p class="location-label">Fridge Location:</p>
                <p class="location-value">${found.fridgeLocation || 'N/A'}</p>
                <p class="location-label">Concentrated Electrolyte Cupboard Location:</p>
                <p class="location-value">${found.concentratedElectrolyteCupboardLocation || 'N/A'}</p>
            `;

            if (found.remark && found.remark.trim() !== '') {
                resultHTML += `
                    <p class="location-label">Remark:</p>
                    <p class="location-value">${found.remark}</p>
                `;
            }

            resultDiv.innerHTML = resultHTML;
        } else {
            resultDiv.innerHTML = 'No cupboard information found for this ward';
        }
    }

    function updateWardSelect() {
        const select = document.getElementById('wardSelect');
        select.innerHTML = '<option value="">Please select a ward</option>';
        
        Array.from(wards).sort(sortWardsDesc).forEach(ward => {
            const option = document.createElement('option');
            option.value = ward;
            option.textContent = ward;
            select.appendChild(option);
        });

        select.onchange = handleWardSelection;
    }

    function handleWardSelection() {
        const selectedWard = document.getElementById('wardSelect').value;
        const itemCodeFilter = document.getElementById('itemCodeFilter');
        const scanButton = document.getElementById('scanButton');
        
        if (selectedWard) {
            itemCodeFilter.disabled = false;
            scanButton.disabled = false;
            itemCodeFilter.placeholder = "Enter Item Code";
            displayItemCodes();
        } else {
            itemCodeFilter.disabled = true;
            scanButton.disabled = true;
            itemCodeFilter.placeholder = "Please select a ward first";
            itemCodeFilter.value = '';
            document.getElementById('result').innerHTML = '';
        }
    }

    function parseWard(ward) {
        const match = ward.match(/^([A-Za-z]+)(\d+)(.*)$/);
        if (match) {
            const letters = match[1].toUpperCase();
            const number = parseInt(match[2], 10);
            const suffix = match[3].toUpperCase();
            return { letters, number, suffix };
        }
        return { letters: '', number: 0, suffix: '' };
    }

    function sortWardsDesc(a, b) {
        const wa = parseWard(a);
        const wb = parseWard(b);

        if (wa.number > wb.number) return -1;
        if (wa.number < wb.number) return 1;

        if (wa.letters < wb.letters) return -1;
        if (wa.letters > wb.letters) return 1;

        if (wa.suffix < wb.suffix) return -1;
        if (wa.suffix > wb.suffix) return 1;

        return 0;
    }

    function displayItemCodes() {
        const selectedWard = document.getElementById('wardSelect').value;
        const resultDiv = document.getElementById('result');

        resultDiv.innerHTML = '';
        document.getElementById('qrCodeContainer').innerHTML = '';

        if (!selectedWard) {
            resultDiv.innerHTML = 'Please select a ward';
            return;
        }

        const wardItems = data
            .filter(row => row.ward === selectedWard)
            .map(row => row.itemCode)
            .filter(itemCode => itemCode)
            .sort();

        if (wardItems.length > 0) {
            const uniqueItemCodes = [...new Set(wardItems)];
            uniqueItemCodes.sort();

            let itemListHTML = `<h3>Item Codes in Ward ${selectedWard}:</h3>`;
            uniqueItemCodes.forEach(itemCode => {
                const found = data.find(row => row.ward === selectedWard && row.itemCode.toString() === itemCode.toString());
                if (found) {
                    itemListHTML += `
                        <details>
                            <summary>${itemCode}</summary>
                            <div class="wardDropdown">
                                <p class="ward-title">Ward: ${found.ward}</p>
                                <p class="location-label">Item Code:</p>
                                <p class="location-value">${found.itemCode}</p>
                                <p class="location-label">Item Description:</p>
                                <p class="item-description">${itemDescriptions.get(found.itemCode) || 'No description available'}</p>
                                <p class="location-label">Location:</p>
                                <p class="location-value">${found.location || 'N/A'}</p>
                                ${((selectedWard.toUpperCase() === 'B6' || selectedWard.toUpperCase() === 'D6') && 
                                   (found.location.startsWith('***E') || found.location.startsWith('**E'))) ? `
                                    <p class="location-label">Description:</p>
                                    <p class="location-value">Scan it to open the drug locker directly.</p>
                                    <div class="qr-code">
                                        <canvas id="qr-${itemCode}"></canvas>
                                        <p class="item-code">Item Code: ${itemCode}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </details>
                    `;
                }
            });
            resultDiv.innerHTML = itemListHTML;

            document.querySelectorAll('#result details').forEach(details => {
                details.addEventListener('toggle', function() {
                    if (this.open) {
                        document.querySelectorAll('#result details').forEach(d => {
                            if (d !== this) d.open = false;
                        });
                    }
                });
            });

            generateQRCodes(selectedWard, uniqueItemCodes);
        } else {
            resultDiv.innerHTML = 'No item codes found for this ward';
        }
    }

    function generateQRCodes(selectedWard, uniqueItemCodes) {
        uniqueItemCodes.forEach(itemCode => {
            const found = data.find(row => row.ward === selectedWard && row.itemCode.toString() === itemCode.toString());
            if (found && (selectedWard.toUpperCase() === 'B6' || selectedWard.toUpperCase() === 'D6') && 
                (found.location.startsWith('***E') || found.location.startsWith('**E'))) {
                const qrCanvas = document.getElementById(`qr-${itemCode}`);
                if (qrCanvas) {
                    new QRious({
                        element: qrCanvas,
                        value: itemCode.toString(),
                        size: 150
                    });
                }
            }
        });
    }

    function filterItemCodes() {
        const filterValue = document.getElementById('itemCodeFilter').value.toLowerCase();
        const detailsElements = document.querySelectorAll('#result details');

        detailsElements.forEach(details => {
            const summary = details.querySelector('summary').textContent.toLowerCase();
            if (summary.includes(filterValue)) {
                details.style.display = '';
            } else {
                details.style.display = 'none';
            }
        });
    }

    function searchLocation() {
        const selectedWard = document.getElementById('wardSelect').value;
        const selectedItemCode = document.getElementById('itemCodeSelect').value;
        const resultDiv = document.getElementById('result');
        const qrCodeContainer = document.getElementById('qrCodeContainer');

        qrCodeContainer.innerHTML = '';

        if (!selectedWard || !selectedItemCode) {
            resultDiv.innerHTML = 'Please select both ward and item code';
            return;
        }

        const found = data.find(row => 
            row.ward === selectedWard && 
            row.itemCode.toString() === selectedItemCode
        );

        if (found) {
            const itemDescription = itemDescriptions.get(selectedItemCode) || 'No description available';
            resultDiv.innerHTML = `
                <h3>Search Result:</h3>
                <div class="result-item">
                    <strong>Ward:</strong> ${found.ward}
                </div>
                <div class="result-item">
                    <strong>Item Code:</strong> ${found.itemCode}
                </div>
                <div class="result-item">
                    <strong>Item Description:</strong><br>
                    <span class="item-description">${itemDescription}</span>
                </div>
                <div class="result-item">
                    <strong>Location:</strong><br>
                    <span class="location-text">${found.location}</span>
                </div>
            `;

            if ((selectedWard.toUpperCase() === 'B6' || selectedWard.toUpperCase() === 'D6') && found.location.startsWith('***E')) {
                const description = document.createElement('p');
                description.className = 'qr-description';
                description.textContent = 'Scan it to open the drug locker directly.';
                qrCodeContainer.appendChild(description);

                const qr = new QRious({
                    value: selectedItemCode,
                    size: 150
                });

                const img = document.createElement('img');
                img.src = qr.toDataURL();
                img.alt = `QR Code for Item Code ${selectedItemCode}`;
                img.style.marginTop = '10px';
                img.style.width = '150px';
                img.style.height = '150px';
                img.style.display = 'block';
                img.style.marginLeft = 'auto';
                img.style.marginRight = 'auto';
                qrCodeContainer.appendChild(img);

                const itemCodeText = document.createElement('p');
                itemCodeText.className = 'item-code';
                itemCodeText.textContent = `Item Code: ${selectedItemCode}`;
                qrCodeContainer.appendChild(itemCodeText);
            }
        } else {
            resultDiv.innerHTML = 'No matching records found';
        }
    }

    function showFullSchedule() {
        document.getElementById('fullSchedule').style.display = 'block';
        document.getElementById('dutyQuery').style.display = 'none';
    }

    function showDutyQuery() {
        document.getElementById('dutyQuery').style.display = 'block';
        document.getElementById('fullSchedule').style.display = 'none';
    }

    function performDutySearch() {
        const dutySelect = document.getElementById('dutySelect').value;
        const weekdaySelect = document.getElementById('weekdaySelect').value;
        const scannerTextbox = document.getElementById('scannerTextbox');
        const resultDiv = document.getElementById('dutyQueryResult');

        scannerTextbox.value = '';
        resultDiv.innerHTML = '';

        if (!dutySelect || !weekdaySelect) {
            alert('Please select both Duty and Weekday.');
            return;
        }

        const scanner = dutyWeekdayScannerMap[dutySelect][weekdaySelect];
        
        if (!scanner) {
            scannerTextbox.value = 'No Scanner Assigned';
            resultDiv.innerHTML = 'No Scanner assigned for the selected Duty and Weekday.';
            return;
        }

        scannerTextbox.value = scanner;

        const weekdayColumnMap = {
            "Monday": "MON",
            "Tuesday": "TUE",
            "Wednesday": "WED",
            "Thursday": "THU",
            "Friday": "FRI"
        };

        const column = weekdayColumnMap[weekdaySelect];
        if (!column) {
            resultDiv.innerHTML = 'Invalid Weekday selected.';
            return;
        }

        const scannerUpper = scanner.toUpperCase();

        const matchedWards = cupboardData
            .filter(row => row[column] && row[column].toUpperCase() === scannerUpper)
            .map(row => row.ward)
            .filter(ward => ward)
            .sort(sortWardsDesc);

        if (matchedWards.length > 0) {
            const uniqueWards = [...new Set(matchedWards)];
            uniqueWards.sort(sortWardsDesc);
            let wardListHTML = `<h3>Wards with ${scanner} on ${weekdaySelect}:</h3>`;
            uniqueWards.forEach(ward => {
                const found = cupboardData.find(row => row.ward === ward);
                if (found) {
                    wardListHTML += `
                        <details>
                            <summary>${ward}</summary>
                            <div class="wardDropdown">
                                <p class="ward-title">Ward: ${found.ward}</p>
                                <p class="location-label">Ward Stock Cupboard Location:</p>
                                <p class="location-value">${found.wardStockCupboardLocation || 'N/A'}</p>
                                <p class="location-label">Fridge Location:</p>
                                <p class="location-value">${found.fridgeLocation || 'N/A'}</p>
                                <p class="location-label">Concentrated Electrolyte Cupboard Location:</p>
                                <p class="location-value">${found.concentratedElectrolyteCupboardLocation || 'N/A'}</p>
                                ${found.remark && found.remark.trim() !== '' ? `
                                    <p class="location-label">Remark:</p>
                                    <p class="location-value">${found.remark}</p>
                                ` : ''}
                            </div>
                        </details>
                    `;
                }
            });
            resultDiv.innerHTML = wardListHTML;

            document.querySelectorAll('#dutyQueryResult details').forEach(details => {
                details.addEventListener('toggle', function() {
                    if (this.open) {
                        document.querySelectorAll('#dutyQueryResult details').forEach(d => {
                            if (d !== this) d.open = false;
                        });
                    }
                });
            });
        } else {
            resultDiv.innerHTML = `No wards found with ${scanner} on ${weekdaySelect}.`;
        }
    }

    async function autoSelectWeekday() {
        const currentDate = new Date();
        const weekdayNumber = currentDate.getDay();
        const weekdayMap = {
            1: "Monday",
            2: "Tuesday",
            3: "Wednesday",
            4: "Thursday",
            5: "Friday",
            6: "Saturday",
            0: "Sunday"
        };
        const currentWeekday = weekdayMap[weekdayNumber] || "Monday";
        document.getElementById('weekdaySelect').value = currentWeekday;
    }

    function startScanner() {
        const selectedWard = document.getElementById('wardSelect').value;
        if (!selectedWard) {
            alert('Please select a ward first');
            return;
        }

        const modal = document.getElementById('scannerModal');
        const video = document.getElementById('scanner-video');

        modal.style.display = 'block';

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: "environment",
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    focusMode: "continuous",
                    frameRate: { ideal: 30 }
                }
            })
            .then(function(stream) {
                video.srcObject = stream;
                video.setAttribute('playsinline', true);
                video.play();
                scanning = true;
                scanBarcodes();
            })
            .catch(function(error) {
                console.error("Camera error: ", error);
                alert("Error accessing camera. Please ensure camera permissions are granted.");
            });
        }
    }

    async function scanBarcodes() {
        const video = document.getElementById('scanner-video');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        scanning = true;

        worker.onmessage = function(e) {
            if (e.data.error) return;
            scanning = false;
            handleScannedBarcode(e.data.text, e.data.format);
        };

        async function tick() {
            if (!scanning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = 640;
                canvas.height = 480;
                context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, canvas.width, canvas.height);

                preprocessImage(context, canvas);
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height).data;
                worker.postMessage({ imageData: new Uint8ClampedArray(imageData), width: canvas.width, height: canvas.height });
            }

            if (scanning) {
                requestAnimationFrame(tick);
            }
        }

        tick();
    }

    function preprocessImage(context, canvas) {
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            const brightness = (r + g + b) / 3;

            const contrast = brightness > 128 ? 255 : 0;
            data[i] = contrast;
            data[i + 1] = contrast;
            data[i + 2] = contrast;
        }

        context.putImageData(imageData, 0, 0);
    }

    function handleScannedBarcode(scannedText, format) {
        const normalizedText = normalizeBarcode(scannedText);
        let itemCode;

        if (format === ZXing.BarcodeFormat.DATA_MATRIX) {
            let cleanText = scannedText.replace(/[^0-9]/g, '');
            if (cleanText.length < 15) {
                cleanText = cleanText.padEnd(15, '0');
            }
            itemCode = productIdMap.get(cleanText);
        } else if (format === ZXing.BarcodeFormat.EAN_13 || format === ZXing.BarcodeFormat.CODE_128) {
            itemCode = productIdMap.get(normalizedText);
        } else if (format === ZXing.BarcodeFormat.QR_CODE && scannedText.includes('<F>') && scannedText.includes('</F>')) {
            const fMatch = scannedText.match(/<F>(.*?)<\/F>/);
            itemCode = fMatch ? fMatch[1] : null;
        }

        if (itemCode) {
            handleItemCode(itemCode);
        } else {
           const errorMessage = `
            <p><span class="highlight">狀態:</span> 未在系統中登記</p>
            <p><span class="highlight">掃描到的條碼:</span> ${normalizedText}</p>
            <p><span class="highlight">條碼格式:</span> ${formatName}</p>
        `;
        displayScanResult(errorMessage, false);
        setTimeout(() => resetScanner(), 2000);
        }
    }

    function handleItemCode(itemCode) {
        if (!itemCode) return;

        const selectedWard = document.getElementById('wardSelect').value;
        if (!selectedWard) {
            displayScanResult('請先選擇病房', false);
            setTimeout(() => resetScanner(), 2000);
            return;
        }

        console.log('處理商品代碼:', itemCode);

        const itemInfo = data.find(row => 
            row.ward === selectedWard && 
            row.itemCode.toString() === itemCode.toString()
        );

        if (itemInfo) {
            const resultHTML = `
                <p><span class="highlight">Ward:</span> ${itemInfo.ward}</p>
                <p><span class="highlight">Item Code:</span> ${itemInfo.itemCode}</p>
                <p><span class="highlight">Description:</span> ${itemDescriptions.get(itemCode) || '無描述'}</p>
                <p><span class="highlight">Location:</span> ${itemInfo.location}</p>
            `;

            if ((selectedWard.toUpperCase() === 'B6' || selectedWard.toUpperCase() === 'D6') && 
                (itemInfo.location.startsWith('***E') || itemInfo.location.startsWith('**E'))) {
                displayScanResultWithQrCode(resultHTML, itemCode, true);
            } else {
                displayScanResult(resultHTML, true);
            }

            document.getElementById('itemCodeFilter').value = itemCode;
            filterItemCodes();
        } else {
            displayScanResult(`此物品 (${itemCode}) 並非 ${selectedWard} 的 ward stock item`, false);
        }

        setTimeout(() => resetScanner(), 2000);
    }

    function resetScanner() {
        const video = document.getElementById('scanner-video');
        scanning = true;
        if (video && video.srcObject) {
            requestAnimationFrame(scanBarcodes);
        }
    }

    function displayScanResultWithQrCode(message, itemCode, isSuccess, autoReset = true) {
        const resultDisplay = document.querySelector('.scan-result-display');

        if (resultDisplay) {
            resultDisplay.style.display = 'block';

            const displayContent = `
                <div class="result-container">
                    <div class="qr-code-section">
                        <p class="qr-reminder">請掃瞄此二維碼打開所屬藥格</p>
                        <canvas id="scan-result-qr" width="150" height="150"></canvas>
                    </div>
                    <div class="text-result-section">
                        ${message}
                    </div>
                </div>
            `;

            resultDisplay.innerHTML = displayContent;

            const qrCanvas = document.getElementById('scan-result-qr');
            if (qrCanvas) {
                try {
                    new QRious({
                        element: qrCanvas,
                        value: itemCode,
                        size: 150,
                        level: 'H'
                    });
                } catch (error) {
                    console.error('QR Code generation error:', error);
                }
            }

            if (autoReset) {
                const resetDelay = isSuccess ? 2000 : 1500;
                setTimeout(() => resetScanner(), resetDelay);
            }
        }
    }

    function displayScanResult(message, isSuccess, autoReset = true) {
        const resultDisplay = document.querySelector('.scan-result-display');

        if (resultDisplay) {
            resultDisplay.style.display = 'block';

            const messageStyle = `
                color: ${isSuccess ? '#4CAF50' : '#f44336'}; 
                font-weight: ${isSuccess ? 'normal' : 'bold'}; 
                text-align: ${isSuccess ? 'left' : 'center'};
            `;

            const displayContent = `
                <div class="text-result-section" style="${messageStyle}">
                    ${message}
                </div>
            `;

            resultDisplay.innerHTML = displayContent;

            if (autoReset) {
                const resetDelay = isSuccess ? 2000 : 1500;
                setTimeout(() => resetScanner(), resetDelay);
            }
        }
    }

    function closeScanner() {
        const modal = document.getElementById('scannerModal');
        const video = document.getElementById('scanner-video');
        
        scanning = false;
        
        if (video.srcObject) {
            const tracks = video.srcObject.getTracks();
            tracks.forEach(track => track.stop());
            video.srcObject = null;
        }
        
        modal.style.display = 'none';
    }
</script>
</body>
</html>