<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ward Stock System</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .banner {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .banner-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        .search-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        select, input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #result, #cupboardResult, #dutyQueryResult, .wardDropdown {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            word-break: break-word;
        }
        #loading, #cupboardLoading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .location-text {
            font-weight: bold;
            font-size: 180%;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #ddd;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
            white-space: nowrap;
            text-align: center;
        }
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .ward-title {
            font-size: 150%;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .location-label {
            font-weight: normal;
            margin-top: 15px;
            margin-bottom: 5px;
        }
        .location-value {
            font-size: 150%;
            font-weight: bold;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        .update-info {
            font-style: italic;
            color: #666;
            margin-bottom: 15px;
        }
        .item-description {
            white-space: normal;
            word-wrap: break-word;
            overflow: visible;
            text-overflow: unset;
            max-width: 100%;
            display: block;
            line-height: 1.4;
            margin-bottom: 10px;
            font-size: 50%;
        }
        .search-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .scan-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .scan-button:hover {
            background-color: #45a049;
        }
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        .scanner-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }
        .scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        #scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }
        @media (max-width: 600px) {
            .tabs {
                flex-direction: column;
            }
            .tab-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="banner">
        <h1 class="banner-title">Top-up Location Helper</h1>
    </div>
    
    <div class="tabs">
        <button class="tab-button active" onclick="switchTab('binShelve', this)">Ward Stock Item Bin Shelve</button>
        <button class="tab-button" onclick="switchTab('cupboard', this)">Ward Stock Cupboard</button>
        <button class="tab-button" onclick="switchTab('dataCaptureSchedule', this)">Data Capture Schedule</button>
    </div>

    <!-- Bin Shelve Tab -->
    <div id="binShelveTab" class="tab-content active container">
        <h1>Ward Stock Item Bin Shelve Checker</h1>
        <div id="binShelveUpdateInfo" class="update-info"></div>
        <div id="itemPhqUpdateInfo" class="update-info"></div>
        <div id="productIdUpdateInfo" class="update-info"></div>
        
        <div id="loading">Loading...</div>
        <div id="error" class="error"></div>

        <div class="search-group">
            <label for="wardSelect">Ward:</label>
            <select id="wardSelect" onchange="onWardSelect()">
                <option value="">Please select a ward</option>
            </select>
        </div>

        <div class="search-group">
            <label for="itemCodeFilter">Filter by Item Code:</label>
            <div class="search-input-group">
                <input type="text" id="itemCodeFilter" placeholder="Enter Item Code" oninput="filterItemCodes()">
                <button id="scanButton" class="scan-button" onclick="startScanner()" disabled>
                    Scan Barcode
                </button>
            </div>
        </div>

        <!-- Scanner Modal -->
        <div id="scannerModal" class="scanner-modal">
            <div class="scanner-content">
                <div class="scanner-header">
                    <span>Scan Barcode</span>
                    <button class="close-button" onclick="closeScanner()">&times;</button>
                </div>
                <div id="scanner-container">
                    <video id="scanner-video" playsinline></video>
                </div>
            </div>
        </div>
        
        <div id="result"></div>
        <div id="qrCodeContainer" class="qr-code"></div>
    </div>

    <!-- Cupboard Tab -->
    <div id="cupboardTab" class="tab-content container">
        <h1>Ward Stock Cupboard Location</h1>
        <div id="cupboardUpdateInfo" class="update-info"></div>

        <div id="cupboardLoading">Loading...</div>
        <div id="cupboardError" class="error"></div>

        <div class="search-group">
            <label for="cupboardWardSelect">Ward:</label>
            <select id="cupboardWardSelect" onchange="searchCupboard()">
                <option value="">Please select a ward</option>
            </select>
        </div>

        <div id="cupboardResult"></div>
    </div>

    <!-- Data Capture Schedule Tab -->
    <div id="dataCaptureScheduleTab" class="tab-content container">
        <h1>Data Capture Schedule</h1>
        <div id="dataCaptureUpdateInfo" class="update-info"></div>
        <div class="schedule-buttons">
            <button onclick="showFullSchedule()">View Full Data Capture Schedule</button>
            <button onclick="showDutyQuery()">Inquire According to Duty</button>
        </div>
        <!-- Full Schedule Section -->
        <div id="fullSchedule" class="hidden">
            <div id="scheduleImages" style="display: flex; flex-direction: column; gap: 20px;">
                <img id="schedule1" src="https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Top_up_schedule_p1.png" alt="Top-up Schedule Page 1">
                <img id="schedule2" src="https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Top_up_schedule_p2.png" alt="Top-up Schedule Page 2">
            </div>
        </div>
        <!-- Duty Query Section -->
        <div id="dutyQuery" class="hidden">
            <div class="duty-query-form">
                <h2>Inquire According to Duty</h2>
                <div class="search-group">
                    <label for="dutySelect">Duty:</label>
                    <select id="dutySelect">
                        <option value="">Please select a duty</option>
                        <option value="TP1-4">TP1-4</option>
                        <option value="I11">I11</option>
                        <option value="EA(I9)">EA(I9)</option>
                        <option value="P4(Main Store Member)">P4(Main Store Member)</option>
                    </select>
                </div>
                <div class="search-group">
                    <label for="weekdaySelect">Weekday:</label>
                    <select id="weekdaySelect">
                        <option value="">Please select a weekday</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                    </select>
                </div>
                <button onclick="performDutySearch()">Search</button>
                <div id="dutyQueryResult"></div>
            </div>
        </div>
    </div>
<script>
// 全局變量
let data = [];
let cupboardData = [];
let itemDescriptions = new Map();
let productIdMap = new Map();
let selectedTab = 'binShelve';
let codeReader = null;

// 文件加載和初始化
window.onload = async function() {
    const locationDate = await getFileLastUpdateDate('Location.xlsx');
    const cupboardDate = await getFileLastUpdateDate('WardStockCupboard.xlsx');
    const itemPhqDate = await getFileLastUpdateDate('item_phq.xlsx');
    const productIdDate = await getFileLastUpdateDate('product_id.xlsx');
    const dataCaptureDate = await getFileLastUpdateDate('Top_up_schedule_p1.png');
    
    document.getElementById('binShelveUpdateInfo').textContent = 
        `Bin shelve information last updated on: ${locationDate}`;
    document.getElementById('cupboardUpdateInfo').textContent = 
        `Ward Stock Cupboard information last updated on: ${cupboardDate}`;
    document.getElementById('itemPhqUpdateInfo').textContent = 
        `Item_phq.xlsx last updated on: ${itemPhqDate}`;
    document.getElementById('productIdUpdateInfo').textContent = 
        `Product ID file last updated on: ${productIdDate}`;
    document.getElementById('dataCaptureUpdateInfo').textContent = 
        `Data Capture last updated on: ${dataCaptureDate}`;

    await Promise.all([
        loadDataFromGitHub(),
        loadCupboardDataFromGitHub(),
        loadItemDescriptions(),
        loadProductIds(),
        autoSelectWeekday()
    ]);
};

// 檔案日期獲取
async function getFileLastUpdateDate(filename) {
    try {
        const response = await fetch(`https://api.github.com/repos/AlexCheung109/WardStockLocationCheck/commits?path=${filename}&page=1&per_page=1`);
        const data = await response.json();
        if (data && data[0] && data[0].commit) {
            const date = new Date(data[0].commit.committer.date);
            return date.toLocaleDateString();
        }
        return 'Unknown';
    } catch (error) {
        console.error('Error fetching file date:', error);
        return 'Unknown';
    }
}

// 加載 Excel 數據
async function loadDataFromGitHub() {
    try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').textContent = '';

        const response = await fetch('https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Location.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        data = XLSX.utils.sheet_to_json(worksheet);
        
        // 填充病房選擇下拉框
        const wards = [...new Set(data.map(row => row.ward))].sort();
        const wardSelects = document.querySelectorAll('#wardSelect, #cupboardWardSelect');
        wardSelects.forEach(select => {
            select.innerHTML = '<option value="">Please select a ward</option>';
            wards.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward;
                option.textContent = ward;
                select.appendChild(option);
            });
        });
    } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('error').textContent = 'Error loading data: ' + error.message;
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

// 加載 Cupboard 數據
async function loadCupboardDataFromGitHub() {
    try {
        document.getElementById('cupboardLoading').style.display = 'block';
        document.getElementById('cupboardError').textContent = '';

        const response = await fetch('https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/WardStockCupboard.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        cupboardData = XLSX.utils.sheet_to_json(worksheet);
    } catch (error) {
        console.error('Error loading cupboard data:', error);
        document.getElementById('cupboardError').textContent = 'Error loading cupboard data: ' + error.message;
    } finally {
        document.getElementById('cupboardLoading').style.display = 'none';
    }
}

// 加載物品描述
async function loadItemDescriptions() {
    try {
        const response = await fetch('https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/item_phq.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        const itemData = XLSX.utils.sheet_to_json(worksheet, {
            header: ['itemCode', 'description']
        });

        itemDescriptions = new Map(
            itemData.map(row => [row.itemCode.toString(), row.description])
        );
    } catch (error) {
        console.error('Error loading item descriptions:', error);
    }
}

// 加載產品ID
async function loadProductIds() {
    try {
        const response = await fetch('https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Product_ID.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        const productData = XLSX.utils.sheet_to_json(worksheet, {
            header: ['itemCode', 'productId']
        });

        productIdMap = new Map(
            productData.map(row => [row.productId.toString(), row.itemCode.toString()])
        );
    } catch (error) {
        console.error('Error loading product IDs:', error);
    }
}

// Tab 切換功能
function switchTab(tabId, button) {
    // 更新按鈕樣式
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');

    // 更新內容顯示
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabId + 'Tab').classList.add('active');
    selectedTab = tabId;

    // 重置掃描器
    if (codeReader && tabId !== 'binShelve') {
        codeReader.reset();
        closeScanner();
    }
}

// 病房選擇處理
function onWardSelect() {
    const wardSelect = document.getElementById('wardSelect');
    document.getElementById('itemCodeFilter').value = '';
    document.getElementById('result').innerHTML = '';
    document.getElementById('scanButton').disabled = !wardSelect.value;
}

// 物品代碼過濾
function filterItemCodes() {
    const ward = document.getElementById('wardSelect').value;
    if (!ward) {
        document.getElementById('result').innerHTML = 'Please select a ward first.';
        return;
    }

    const filterText = document.getElementById('itemCodeFilter').value.trim().toUpperCase();
    if (!filterText) {
        document.getElementById('result').innerHTML = '';
        return;
    }

    // 檢查是否為產品ID
    const itemCode = productIdMap.get(filterText) || filterText;
    
    const filteredData = data.filter(row => 
        row.ward === ward && 
        row.item_code.toString().includes(itemCode)
    );

    displayResults(filteredData, itemCode);
}

// 顯示搜索結果
function displayResults(filteredData, searchText) {
    const resultDiv = document.getElementById('result');
    if (filteredData.length === 0) {
        resultDiv.innerHTML = `No results found for "${searchText}"`;
        return;
    }

    let html = '';
    filteredData.forEach(row => {
        const description = itemDescriptions.get(row.item_code.toString()) || 'No description available';
        html += `
            <div class="ward-title">${row.ward}</div>
            <div class="item-description">
                Item Code: ${row.item_code}<br>
                Description: ${description}
            </div>
            <div class="location-label">Location:</div>
            <div class="location-text">${row.location || 'Location not specified'}</div>
            <hr>
        `;
    });
    resultDiv.innerHTML = html;
}

// Cupboard 搜索功能
function searchCupboard() {
    const ward = document.getElementById('cupboardWardSelect').value;
    const resultDiv = document.getElementById('cupboardResult');

    if (!ward) {
        resultDiv.innerHTML = 'Please select a ward.';
        return;
    }

    const wardData = cupboardData.filter(row => row.ward === ward);
    if (wardData.length === 0) {
        resultDiv.innerHTML = 'No cupboard data found for this ward.';
        return;
    }

    let html = `<h2>${ward} Cupboard Locations</h2>`;
    wardData.forEach(row => {
        html += `
            <div class="location-label">Cupboard Number:</div>
            <div class="location-value">${row.cupboard_no || 'Not specified'}</div>
            <div class="location-label">Location:</div>
            <div class="location-value">${row.location || 'Not specified'}</div>
            <hr>
        `;
    });
    resultDiv.innerHTML = html;
}

// 條碼掃描功能
async function startScanner() {
    const modal = document.getElementById('scannerModal');
    const video = document.getElementById('scanner-video');
    
    modal.style.display = 'block';
    
    if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
    }

    try {
        await codeReader.decodeFromVideoDevice(null, video, (result, err) => {
            if (result) {
                const scannedCode = result.getText();
                document.getElementById('itemCodeFilter').value = scannedCode;
                filterItemCodes();
                closeScanner();
            }
        });
    } catch (err) {
        console.error(err);
        alert('Error accessing camera: ' + err.message);
        closeScanner();
    }
}

// 關閉掃描器
function closeScanner() {
    const modal = document.getElementById('scannerModal');
    modal.style.display = 'none';
    if (codeReader) {
        codeReader.reset();
    }
}

// 自動選擇當前星期
function autoSelectWeekday() {
    const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const today = new Date().getDay();
    if (today > 0 && today < 6) { // 只在週一到週五自動選擇
        const weekdaySelect = document.getElementById('weekdaySelect');
        if (weekdaySelect) {
            weekdaySelect.value = weekdays[today];
        }
    }
}

// 工作查詢功能
function performDutySearch() {
    const duty = document.getElementById('dutySelect').value;
    const weekday = document.getElementById('weekdaySelect').value;
    const resultDiv = document.getElementById('dutyQueryResult');

    if (!duty || !weekday) {
        resultDiv.innerHTML = 'Please select both duty and weekday.';
        return;
    }

    // 這裡可以添加具體的工作查詢邏輯
    // 目前僅顯示選擇的值
    resultDiv.innerHTML = `
        <h3>Search Results:</h3>
        <p>Duty: ${duty}</p>
        <p>Weekday: ${weekday}</p>
    `;
}

// 顯示完整排程
function showFullSchedule() {
    document.getElementById('fullSchedule').style.display = 'block';
    document.getElementById('dutyQuery').style.display = 'none';
}

// 顯示工作查詢
function showDutyQuery() {
    document.getElementById('fullSchedule').style.display = 'none';
    document.getElementById('dutyQuery').style.display = 'block';
}
</script>
</body>
</html>