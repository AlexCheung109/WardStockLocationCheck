<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ward Stock System</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Include QRious Library for QR Code Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<!-- Include jsQR Library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<!-- 在 head 部分添加，在其他 script 標籤後面 -->
<script src="https://unpkg.com/@zxing/library@latest"></script>


    <style>

.result-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    width: 100%;
    max-width: 400px;
    margin: 20px auto;
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.qr-code-section {
    background-color: #fff;
    padding: 20px;
    display: flex;
    flex-direction: column; /* 垂直排列，確保提示文字在上方 */
    align-items: center;
    justify-content: center;
    width: 100%;
    border-bottom: 1px solid #ddd;
}

.qr-code-section canvas {
    width: 150px;
    height: 150px;
}
.animate-spin {
    animation: spin 1s linear infinite;
}

.qr-reminder {
    font-size: 14px;
    color: #333;
    text-align: center;
    margin-bottom: 10px; /* 與二維碼之間的間距 */
}

.text-result-section {
    width: 100%;
    word-wrap: break-word;
}

.text-result-section p {
    font-size: 14px;
    margin: 10px 0;
}

.text-result-section.error {
    color: #f44336; /* 紅色 */
    font-weight: bold; /* 粗體 */
    text-align: center; /* 置中 */
    font-size: 16px;
}
.text-result-section .highlight {
    font-weight: bold;
    color: #4CAF50;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.required {
    color: red;
    margin-left: 4px;
}

select:disabled,
input:disabled {
    background-color: #f5f5f5;
    cursor: not-allowed;
}

button:disabled {
    background-color: #cccccc !important;
    cursor: not-allowed;
    opacity: 0.7;
}

.search-group label {
    font-weight: bold;
}


input:disabled {
    background-color: #f5f5f5;
    cursor: not-allowed;
}

button:disabled {
    background-color: #cccccc !important;
    cursor: not-allowed;
    opacity: 0.7;
}
.scanner-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60%;
    height: 40%;
    border: 2px solid #4CAF50;
    border-radius: 10px;
    z-index: 2;
}

.overlay-mask {
    position: absolute;
    background: rgba(0, 0, 0, 0.5);
}

.overlay-top {
    top: 0;
    left: 0;
    right: 0;
    height: calc(50% - 60px); /* 調整高度以配合掃描框 */
}

.overlay-bottom {
    bottom: 0;
    left: 0;
    right: 0;
    height: calc(50% - 60px);
}

.overlay-left {
    top: calc(50% - 60px);
    left: 0;
    width: calc(50% - 120px);
    height: 120px;
}

.overlay-right {
    top: calc(50% - 60px);
    right: 0;
    width: calc(50% - 120px);
    height: 120px;
}



        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .banner {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .banner-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        .search-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        select, input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #result, #cupboardResult, #dutyQueryResult, .wardDropdown {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            word-break: break-word;
        }
        #loading, #cupboardLoading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .location-text {
            font-weight: bold;
            font-size: 180%;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping if needed */
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #ddd;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex: 1;
            white-space: nowrap;
            text-align: center;
        }
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .ward-title {
            font-size: 150%;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .location-label {
            font-weight: normal;
            margin-top: 15px;
            margin-bottom: 5px;
        }
        .location-value {
            font-size: 150%;
            font-weight: bold;
            margin-top: 5px;
            margin-bottom: 15px;
        }
        .update-info {
            font-style: italic;
            color: #666;
            margin-bottom: 15px;
        }
        .item-description {
            white-space: normal;
            word-wrap: break-word;
            overflow: visible;
            text-overflow: unset;
            max-width: 100%;
            display: block;
            line-height: 1.4;
            margin-bottom: 10px;
            font-size: 50%; /* Reduced font size by half */
        }
        #scheduleImages img {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            width: 100%;
            max-width: 100%;
            height: auto;
            margin-bottom: 20px;
        }
        #dataCaptureScheduleTab {
            text-align: center;
        }
        #dataCaptureScheduleTab h1 {
            text-align: left;
        }
        .result-item {
            margin-bottom: 15px;
        }
        /* QR Code Container Style */
        .qr-code {
            margin-top: 20px;
            text-align: center;
        }
        /* Description Text Style */
        .qr-description {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
.search-input-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.scan-button {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.scan-button:hover {
    background-color: #45a049;
}
.scanner-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    overflow: auto; /* 添加滾動條以適應長內容 */
    background-color: rgba(0, 0, 0, 0.7); /* 背景半透明 */
}

.scanner-content {
    position: relative;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    max-height: 90%; /* 限制內容高度 */
    overflow-y: auto; /* 如果內容超長，啟用滾動條 */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
.scan-result-content {
    text-align: left;
    width: 100%;
}

.scan-result-content div {
    margin-bottom: 8px;
}

.scan-result-location {
    font-weight: bold;
    color: #4CAF50;
}

.scan-result-description {
    font-size: 0.9em;
    color: #666;
}

.scan-result-display {
    background-color: white;
    padding: 15px;
    margin-top: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 3;
    min-height: 200px; /* 確保有足夠空間 */
    display: flex;
    flex-direction: column;
    align-items: center;
}
.scanner-header {
    background: transparent;
    color: white;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 3;
}

.close-button:hover {
    background: #ff0000;
}

#scanner-container {
    position: relative;
    width: 100%;
    height: 300px;
    margin-bottom: 10px;
    overflow: hidden;
}

#scanner-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
}
        /* Item Code Text Style */
        .item-code {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        /* New Styles for Data Capture Schedule Tab */
        .schedule-buttons {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column; /* Vertical alignment */
            gap: 10px; /* Space between buttons */
        }
        .hidden {
            display: none;
        }
        /* Duty Query Form Styles */
        .duty-query-form {
            background-color: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 20px;
        }
        .duty-query-form label {
            margin-top: 10px;
        }
        /* Styles for Accordion */
        details {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff;
        }
        summary {
            font-weight: bold;
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }
        /* Hide default markers */
        summary::-webkit-details-marker {
            display: none;
        }
        summary::marker {
            display: none;
        }
        summary::after {
            content: "▼";
            position: absolute;
            right: 0;
            top: 0;
            transition: transform 0.2s;
        }
        details[open] summary::after {
            transform: rotate(-180deg);
        }
        /* Accordion Dropdown Styles */
        .wardDropdown {
            margin-top: 10px;
        }
        /* Responsive Tabs: Switch to vertical on small screens */
        @media (max-width: 600px) {
            .tabs {
                flex-direction: column;
            }
            .tab-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="banner">
        <h1 class="banner-title">Top-up Location Helper</h1>
    </div>
    
    <div class="tabs">
        <button class="tab-button active" onclick="switchTab('binShelve', this)">Ward Stock Item Bin Shelve</button>
        <button class="tab-button" onclick="switchTab('cupboard', this)">Ward Stock Cupboard</button>
        <button class="tab-button" onclick="switchTab('dataCaptureSchedule', this)">Data Capture Schedule</button>
    </div>

    <!-- Bin Shelve Tab -->
    <div id="binShelveTab" class="tab-content active container">
        <h1>Ward Stock Item Bin Shelve Checker</h1>
        <div id="binShelveUpdateInfo" class="update-info"></div>
        <div id="productIdUpdateInfo" class="update-info"></div>
        <div id="itemPhqUpdateInfo" class="update-info"></div>
        
        <div id="loading">Loading...</div>
        <div id="error" class="error"></div>

<div class="search-group">
    <label for="wardSelect">Ward: <span class="required">*</span></label>
    <select id="wardSelect">
        <option value="">Please select a ward</option>
    </select>
</div>

<!-- Item Code Filter -->
<div class="search-group">
    <label for="itemCodeFilter">Filter by Item Code:</label>
    <div class="search-input-group">
        <input type="text" 
               id="itemCodeFilter" 
               placeholder="Please select a ward first" 
               disabled 
               oninput="filterItemCodes()">
        <button id="scanButton" 
                class="scan-button" 
                onclick="startScanner()" 
                disabled>
            Scan Barcode
        </button>
    </div>
</div>

<!-- Scanner Modal -->
<div id="scannerModal" class="scanner-modal">
    <div class="scanner-content">
        <!-- Close Button -->
        <button class="close-button" onclick="closeScanner()">&times;</button>

        <!-- Scanner Video -->
        <div id="scanner-container">
            <video id="scanner-video" playsinline></video>
            <!-- 遮罩層 -->
            <div class="overlay-mask overlay-top"></div>
            <div class="overlay-mask overlay-bottom"></div>
            <div class="overlay-mask overlay-left"></div>
            <div class="overlay-mask overlay-right"></div>
            <!-- 掃描框 -->
            <div class="scanner-overlay"></div>
        </div>

        <!-- 掃描結果區域 -->
        <div class="scan-result-display" style="display: none;">
            <div class="scan-result-content"></div>
        </div>
    </div>
</div>
        <!-- Removed the Item Code Select and Search Button -->
        <!-- The item codes will be displayed automatically upon ward selection -->

        <div id="result"></div>
        <!-- QR Code Container -->
        <div id="qrCodeContainer" class="qr-code"></div>
    </div>

    <!-- Cupboard Tab -->
    <div id="cupboardTab" class="tab-content container">
        <h1>Ward Stock Cupboard Location</h1>
        <div id="cupboardUpdateInfo" class="update-info"></div>

        <div id="cupboardLoading">Loading...</div>
        <div id="cupboardError" class="error"></div>

        <div class="search-group">
            <label for="cupboardWardSelect">Ward:</label>
            <select id="cupboardWardSelect" onchange="searchCupboard()">
                <option value="">Please select a ward</option>
            </select>
        </div>

        <div id="cupboardResult"></div>
    </div>

    <!-- Data Capture Schedule Tab -->
    <div id="dataCaptureScheduleTab" class="tab-content container">
        <h1>Data Capture Schedule</h1>
        <div id="dataCaptureUpdateInfo" class="update-info"></div>
        <div class="schedule-buttons">
            <button onclick="showFullSchedule()">View Full Data Capture Schedule</button>
            <button onclick="showDutyQuery()">Inquire According to Duty</button>
        </div>
        <!-- Full Schedule Section -->
        <div id="fullSchedule" class="hidden">
            <div id="scheduleImages" style="display: flex; flex-direction: column; gap: 20px;">
                <img id="schedule1" src="https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Top_up_schedule_p1.png" alt="Top-up Schedule Page 1">
                <img id="schedule2" src="https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Top_up_schedule_p2.png" alt="Top-up Schedule Page 2">
            </div>
        </div>
        <!-- Duty Query Section -->
        <div id="dutyQuery" class="hidden">
            <div class="duty-query-form">
                <h2>Inquire According to Duty</h2>
                <div class="search-group">
                    <label for="dutySelect">Duty:</label>
                    <select id="dutySelect">
                        <option value="">Please select a duty</option>
                        <option value="TP1-4">TP1-4</option>
                        <option value="I11">I11</option>
                        <option value="EA(I9)">EA(I9)</option>
                        <option value="P4(Main Store Member)">P4(Main Store Member)</option>
                    </select>
                </div>
                <div class="search-group">
                    <label for="weekdaySelect">Weekday:</label>
                    <select id="weekdaySelect">
                        <option value="">Please select a weekday</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                    </select>
                </div>
                <!-- Hidden Scanner Group -->
                <div class="search-group hidden scanner-group">
                    <label for="scannerTextbox">Scanner:</label>
                    <input type="text" id="scannerTextbox" readonly>
                </div>
                <button onclick="performDutySearch()">Search</button>
                <div id="dutyQueryResult"></div>
            </div>
        </div>
    </div>
<script>
    let data = [];
    let wards = new Set();
    let cupboardData = [];
    let cupboardWards = new Set();
    let itemDescriptions = new Map();
let productIdMap = new Map();

    // Mapping for Duty and Weekday to Scanner
    const dutyWeekdayScannerMap = {
        "TP1-4": {
            "Monday": "Scanner L",
            "Tuesday": "Scanner M",
            "Wednesday": "",
            "Thursday": "Scanner M",
            "Friday": "Scanner M"
        },
        "I11": {
            "Monday": "Scanner N",
            "Tuesday": "Scanner L",
            "Wednesday": "Scanner L",
            "Thursday": "Scanner L",
            "Friday": "Scanner O"
        },
        "EA(I9)": {
            "Monday": "",
            "Tuesday": "",
            "Wednesday": "",
            "Thursday": "Scanner O",
            "Friday": "Scanner L"
        },
        "P4(Main Store Member)": {
            "Monday": "Scanner M",
            "Tuesday": "Scanner N",
            "Wednesday": "",
            "Thursday": "Scanner N",
            "Friday": "Scanner N"
        }
    };

    async function getFileLastUpdateDate(filename) {
        try {
            const response = await fetch(`https://api.github.com/repos/AlexCheung109/WardStockLocationCheck/commits?path=${filename}&page=1&per_page=1`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const dataResponse = await response.json();
            if (dataResponse.length > 0) {
                const date = new Date(dataResponse[0].commit.committer.date);
                return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
            }
            return 'Date not available';
        } catch (error) {
            console.error('Error fetching file update date:', error);
            return 'Date not available';
        }
    }

    async function loadItemDescriptions() {
        try {
            const excelUrl = 'https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/item_phq.xlsx';
            const response = await fetch(excelUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const itemData = XLSX.utils.sheet_to_json(worksheet, {
                header: ['itemCode', 'description'],
                range: 0
            });
            itemDescriptions = new Map(
                itemData.map(row => [row.itemCode.toString(), shortenDescription(row.description)])
            );
        } catch (error) {
            console.error('Error loading item descriptions:', error);
            document.getElementById('error').textContent = 'Error loading item descriptions: ' + error.message;
        }
    }

    // Function to shorten descriptions while preserving meaning
    function shortenDescription(description) {
        // Simple example: truncate to 50 characters and add ellipsis
        if (!description) return 'No description available';
        if (description.length <= 50) return description;
        return description.substring(0, 50) + '...';
    }

window.onload = async function() {
    try {
        // 檢查必要的庫是否已載入
        if (!window.ZXing) {
            console.error('ZXing library not loaded');
        }
        if (!window.jsQR) {
            console.error('jsQR library not loaded');
        }

        // 原有的更新日期檢查
        const locationDate = await getFileLastUpdateDate('Location.xlsx');
        const cupboardDate = await getFileLastUpdateDate('WardStockCupboard.xlsx');
        const itemPhqDate = await getFileLastUpdateDate('item_phq.xlsx');
        const dataCaptureDate = await getFileLastUpdateDate('Top_up_schedule_p1.png');
        const productIdDate = await getFileLastUpdateDate('product_id.xlsx');
        
        document.getElementById('binShelveUpdateInfo').textContent = 
            `Bin shelve information last updated on: ${locationDate}`;
        document.getElementById('cupboardUpdateInfo').textContent = 
            `Ward Stock Cupboard information last updated on: ${cupboardDate}`;
        document.getElementById('itemPhqUpdateInfo').textContent = 
            `Item_phq.xlsx last updated on: ${itemPhqDate}`;
        document.getElementById('dataCaptureUpdateInfo').textContent = 
            `Data Capture last updated on: ${dataCaptureDate}`;
        document.getElementById('productIdUpdateInfo').textContent = 
            `Product ID mapping last updated on: ${productIdDate}`;

        // 載入所有必要數據
        await Promise.all([
            loadDataFromGitHub(),
            loadCupboardDataFromGitHub(),
            loadItemDescriptions(),
            loadProductIds(),
            autoSelectWeekday()
        ]);

        console.log('Initialization completed');
        console.log('ZXing available:', !!window.ZXing);
        console.log('jsQR available:', !!window.jsQR);
        console.log('ProductID map size:', productIdMap.size);

    } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('error').textContent = 
            'Error during initialization: ' + error.message;
    }
};

function switchTab(tabId, button) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });

    document.getElementById(tabId + 'Tab').classList.add('active');
    button.classList.add('active');
}

async function loadProductIds() {
    try {
        const excelUrl = 'https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Product_ID.xlsx';
        const response = await fetch(excelUrl);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        const productData = XLSX.utils.sheet_to_json(worksheet, {
            header: ['itemCode', 'productId'],
            range: 1
        });

        // 清空當前的 Map
        productIdMap.clear();
        
        // 直接建立 column B 到 column A 的映射
        productData.forEach(row => {
            if (row.productId && row.itemCode) {
                const productId = row.productId.toString().trim();
                const itemCode = row.itemCode.toString().trim();
                productIdMap.set(productId, itemCode);
            }
        });
        
    } catch (error) {
        alert('載入產品對照表時發生錯誤');
    }
}
function normalizeBarcode(text) {
    // 原有代碼：修正條碼處理邏輯
    const normalizedText = text.toString().trim().toUpperCase();

    // 如果是 UPC-A 格式（12 位數），直接返回原本的條碼，不補 0
    if (/^\d{12}$/.test(normalizedText)) {
        return normalizedText;
    }

    // 其他條碼類型保持原有處理邏輯
    return normalizedText;
}

    async function loadDataFromGitHub() {
        const loading = document.getElementById('loading');
        loading.style.display = 'block';

        try {
            const excelUrl = 'https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/Location.xlsx';
            const response = await fetch(excelUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            data = XLSX.utils.sheet_to_json(worksheet, {
                header: ['ward', 'itemCode', 'c', 'd', 'e', 'f', 'location'],
                range: 1
            });

            data = data.map(row => ({
                ward: row.ward,
                itemCode: row.itemCode,
                location: row.location
            }));

            wards = new Set(data.map(row => row.ward));
            updateWardSelect();
            
            loading.style.display = 'none';
        } catch (error) {
            console.error('Error loading data:', error);
            loading.style.display = 'none';
            document.getElementById('error').textContent = 'Error loading data: ' + error.message;
        }
    }

    async function loadCupboardDataFromGitHub() {
        const loading = document.getElementById('cupboardLoading');
        loading.style.display = 'block';

        try {
            const excelUrl = 'https://raw.githubusercontent.com/AlexCheung109/WardStockLocationCheck/main/WardStockCupboard.xlsx';
            const response = await fetch(excelUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Modify headers to include Weekday columns (Assuming columns B-F correspond to MON-FRI)
            cupboardData = XLSX.utils.sheet_to_json(worksheet, {
                header: ['ward', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'ignore1', 'wardStockCupboardLocation', 'fridgeLocation', 'concentratedElectrolyteCupboardLocation', 'remark'],
                range: 1
            });

            cupboardData = cupboardData.map(row => ({
                ward: row.ward ? row.ward.toString().trim() : '',
                MON: row.MON ? row.MON.toString().trim() : '',
                TUE: row.TUE ? row.TUE.toString().trim() : '',
                WED: row.WED ? row.WED.toString().trim() : '',
                THU: row.THU ? row.THU.toString().trim() : '',
                FRI: row.FRI ? row.FRI.toString().trim() : '',
                wardStockCupboardLocation: row.wardStockCupboardLocation ? row.wardStockCupboardLocation.toString().trim() : '',
                fridgeLocation: row.fridgeLocation ? row.fridgeLocation.toString().trim() : '',
                concentratedElectrolyteCupboardLocation: row.concentratedElectrolyteCupboardLocation ? row.concentratedElectrolyteCupboardLocation.toString().trim() : '',
                remark: row.remark ? row.remark.toString().trim() : ''
            }));

            cupboardWards = new Set(cupboardData.map(row => row.ward));
            updateCupboardWardSelect();
            
            loading.style.display = 'none';
        } catch (error) {
            console.error('Error loading cupboard data:', error);
            loading.style.display = 'none';
            document.getElementById('cupboardError').textContent = 'Error loading cupboard data: ' + error.message;
        }
    }

    function updateCupboardWardSelect() {
        const select = document.getElementById('cupboardWardSelect');
        select.innerHTML = '<option value="">Please select a ward</option>';
        
        Array.from(cupboardWards).sort(sortWardsDesc).forEach(ward => {
            const option = document.createElement('option');
            option.value = ward;
            option.textContent = ward;
            select.appendChild(option);
        });
    }

    function searchCupboard() {
        const selectedWard = document.getElementById('cupboardWardSelect').value;
        const resultDiv = document.getElementById('cupboardResult');

        if (!selectedWard) {
            resultDiv.innerHTML = 'Please select a ward';
            return;
        }

        const found = cupboardData.find(row => row.ward === selectedWard);

        if (found) {
            let resultHTML = `
                <p class="ward-title">Ward: ${found.ward}</p>
                <p class="location-label">Ward Stock Cupboard Location:</p>
                <p class="location-value">${found.wardStockCupboardLocation || 'N/A'}</p>
                <p class="location-label">Fridge Location:</p>
                <p class="location-value">${found.fridgeLocation || 'N/A'}</p>
                <p class="location-label">Concentrated Electrolyte Cupboard Location:</p>
                <p class="location-value">${found.concentratedElectrolyteCupboardLocation || 'N/A'}</p>
            `;

            // Add Remark section if available
            if (found.remark && found.remark.trim() !== '') {
                resultHTML += `
                    <p class="location-label">Remark:</p>
                    <p class="location-value">${found.remark}</p>
                `;
            }

            resultDiv.innerHTML = resultHTML;
        } else {
            resultDiv.innerHTML = 'No cupboard information found for this ward';
        }
    }

// 找到 updateWardSelect 函數，修改如下：
function updateWardSelect() {
    const select = document.getElementById('wardSelect');
    select.innerHTML = '<option value="">Please select a ward</option>';
    
    Array.from(wards).sort(sortWardsDesc).forEach(ward => {
        const option = document.createElement('option');
        option.value = ward;
        option.textContent = ward;
        select.appendChild(option);
    });

    select.onchange = handleWardSelection;
}


// 添加新的函數來處理 ward 選擇
function handleWardSelection() {
    const selectedWard = document.getElementById('wardSelect').value;
    const itemCodeFilter = document.getElementById('itemCodeFilter');
    const scanButton = document.getElementById('scanButton');
    
    if (selectedWard) {
        itemCodeFilter.disabled = false;
        scanButton.disabled = false;
        itemCodeFilter.placeholder = "Enter Item Code";
        displayItemCodes();
    } else {
        itemCodeFilter.disabled = true;
        scanButton.disabled = true;
        itemCodeFilter.placeholder = "Please select a ward first";
        itemCodeFilter.value = '';
        document.getElementById('result').innerHTML = '';
    }
}

    // Helper function to parse ward into letters, number, and suffix
    function parseWard(ward) {
        const match = ward.match(/^([A-Za-z]+)(\d+)(.*)$/);
        if (match) {
            const letters = match[1].toUpperCase();
            const number = parseInt(match[2], 10);
            const suffix = match[3].toUpperCase();
            return { letters, number, suffix };
        }
        return { letters: '', number: 0, suffix: '' };
    }

    // Custom sort function: first by number descending, then by letters ascending
    function sortWardsDesc(a, b) {
        const wa = parseWard(a);
        const wb = parseWard(b);

        // Sort by number descending
        if (wa.number > wb.number) return -1;
        if (wa.number < wb.number) return 1;

        // Then sort by letters ascending
        if (wa.letters < wb.letters) return -1;
        if (wa.letters > wb.letters) return 1;

        // Finally, sort by suffix ascending
        if (wa.suffix < wb.suffix) return -1;
        if (wa.suffix > wb.suffix) return 1;

        return 0;
    }

    // Function to display item codes as clickable accordions
    function displayItemCodes() {
        const selectedWard = document.getElementById('wardSelect').value;
        const resultDiv = document.getElementById('result');

        // Clear previous results
        resultDiv.innerHTML = '';
        document.getElementById('qrCodeContainer').innerHTML = '';

        if (!selectedWard) {
            resultDiv.innerHTML = 'Please select a ward';
            return;
        }

        // Fetch all item codes for the selected ward
        const wardItems = data
            .filter(row => row.ward === selectedWard)
            .map(row => row.itemCode)
            .filter(itemCode => itemCode) // Remove empty item codes
            .sort(); // Sort A-Z

        if (wardItems.length > 0) {
            // Remove duplicates
            const uniqueItemCodes = [...new Set(wardItems)];

            // Sort unique item codes A-Z
            uniqueItemCodes.sort();

            // Create accordion-style details elements
            let itemListHTML = `<h3>Item Codes in Ward ${selectedWard}:</h3>`;
            uniqueItemCodes.forEach(itemCode => {
                const found = data.find(row => row.ward === selectedWard && row.itemCode.toString() === itemCode.toString());
                if (found) {
                    itemListHTML += `
                        <details>
                            <summary>${itemCode}</summary>
                            <div class="wardDropdown">
                                <p class="ward-title">Ward: ${found.ward}</p>
                                <p class="location-label">Item Code:</p>
                                <p class="location-value">${found.itemCode}</p>
                                <p class="location-label">Item Description:</p>
                                <p class="item-description">${itemDescriptions.get(found.itemCode) || 'No description available'}</p>
                                <p class="location-label">Location:</p>
                                <p class="location-value">${found.location || 'N/A'}</p>
                                
                                <!-- 新增的描述和 QR Code 區塊 -->
                                ${ ( (selectedWard.toUpperCase() === 'B6' || selectedWard.toUpperCase() === 'D6') && 
                                     (found.location.startsWith('***E') || found.location.startsWith('**E')) ) ? `
                                    <p class="location-label">Description:</p>
                                    <p class="location-value">Scan it to open the drug locker directly.</p>
                                    
                                    <div class="qr-code">
                                        <canvas id="qr-${itemCode}"></canvas>
                                        <p class="item-code">Item Code: ${itemCode}</p>
                                    </div>
                                ` : ''}
                                
                            </div>
                        </details>
                    `;
                }
            });
            resultDiv.innerHTML = itemListHTML;

            // Enforce single-open accordion behavior
            document.querySelectorAll('#result details').forEach(details => {
                details.addEventListener('toggle', function() {
                    if (this.open) {
                        document.querySelectorAll('#result details').forEach(d => {
                            if (d !== this) d.open = false;
                        });
                    }
                });
            });

            // 生成 QR Code
            generateQRCodes(selectedWard, uniqueItemCodes);
        } else {
            resultDiv.innerHTML = 'No item codes found for this ward';
        }
    }

    // 新增的函數，用於生成 QR Code
    function generateQRCodes(selectedWard, uniqueItemCodes) {
        uniqueItemCodes.forEach(itemCode => {
            const found = data.find(row => row.ward === selectedWard && row.itemCode.toString() === itemCode.toString());
            if (found && (selectedWard.toUpperCase() === 'B6' || selectedWard.toUpperCase() === 'D6') && 
                (found.location.startsWith('***E') || found.location.startsWith('**E'))) {
                const qrCanvas = document.getElementById(`qr-${itemCode}`);
                if (qrCanvas) {
                    // 使用 QRious 生成 QR Code
                    new QRious({
                        element: qrCanvas,
                        value: itemCode.toString(),
                        size: 150
                    });
                }
            }
        });
    }

    // Function to filter item codes based on input
    function filterItemCodes() {
        const filterValue = document.getElementById('itemCodeFilter').value.toLowerCase();
        const detailsElements = document.querySelectorAll('#result details');

        detailsElements.forEach(details => {
            const summary = details.querySelector('summary').textContent.toLowerCase();
            if (summary.includes(filterValue)) {
                details.style.display = '';
            } else {
                details.style.display = 'none';
            }
        });
    }

    function searchLocation() {
        const selectedWard = document.getElementById('wardSelect').value;
        const selectedItemCode = document.getElementById('itemCodeSelect').value;
        const resultDiv = document.getElementById('result');
        const qrCodeContainer = document.getElementById('qrCodeContainer');

        // Clear previous QR code and descriptions
        qrCodeContainer.innerHTML = '';

        if (!selectedWard || !selectedItemCode) {
            resultDiv.innerHTML = 'Please select both ward and item code';
            return;
        }

        const found = data.find(row => 
            row.ward === selectedWard && 
            row.itemCode.toString() === selectedItemCode
        );

        if (found) {
            const itemDescription = itemDescriptions.get(selectedItemCode) || 'No description available';
            resultDiv.innerHTML = `
                <h3>Search Result:</h3>
                <div class="result-item">
                    <strong>Ward:</strong> ${found.ward}
                </div>
                <div class="result-item">
                    <strong>Item Code:</strong> ${found.itemCode}
                </div>
                <div class="result-item">
                    <strong>Item Description:</strong><br>
                    <span class="item-description">${itemDescription}</span>
                </div>
                <div class="result-item">
                    <strong>Location:</strong><br>
                    <span class="location-text">${found.location}</span>
                </div>
            `;

            // Check if selected ward is B6 or D6 AND location starts with '***E'
            if ((selectedWard.toUpperCase() === 'B6' || selectedWard.toUpperCase() === 'D6') && found.location.startsWith('***E')) {
                // Create description text above QR code
                const description = document.createElement('p');
                description.className = 'qr-description';
                description.textContent = 'Scan it to open the drug locker directly.';

                // Append description to QR code container
                qrCodeContainer.appendChild(description);

                // Generate QR code
                const qr = new QRious({
                    value: selectedItemCode,
                    size: 150
                });

                // Create an <img> element to display the QR code
                const img = document.createElement('img');
                img.src = qr.toDataURL();
                img.alt = `QR Code for Item Code ${selectedItemCode}`;
                img.style.marginTop = '10px';
                img.style.width = '150px';
                img.style.height = '150px';
                img.style.display = 'block';
                img.style.marginLeft = 'auto';
                img.style.marginRight = 'auto';

                // Append QR code image to container
                qrCodeContainer.appendChild(img);

                // Create Item Code text below QR code
                const itemCodeText = document.createElement('p');
                itemCodeText.className = 'item-code';
                itemCodeText.textContent = `Item Code: ${selectedItemCode}`;

                // Append Item Code text to container
                qrCodeContainer.appendChild(itemCodeText);
            }
        } else {
            resultDiv.innerHTML = 'No matching records found';
        }
    }

    // Functions to handle Data Capture Schedule Tab
    function showFullSchedule() {
        document.getElementById('fullSchedule').style.display = 'block';
        document.getElementById('dutyQuery').style.display = 'none';
    }

    function showDutyQuery() {
        document.getElementById('dutyQuery').style.display = 'block';
        document.getElementById('fullSchedule').style.display = 'none';
    }

    function performDutySearch() {
        const dutySelect = document.getElementById('dutySelect').value;
        const weekdaySelect = document.getElementById('weekdaySelect').value;
        const scannerTextbox = document.getElementById('scannerTextbox');
        const resultDiv = document.getElementById('dutyQueryResult');

        // Clear previous results
        scannerTextbox.value = '';
        resultDiv.innerHTML = '';

        if (!dutySelect || !weekdaySelect) {
            alert('Please select both Duty and Weekday.');
            return;
        }

        const scanner = dutyWeekdayScannerMap[dutySelect][weekdaySelect];
        
        if (!scanner) {
            scannerTextbox.value = 'No Scanner Assigned';
            resultDiv.innerHTML = 'No Scanner assigned for the selected Duty and Weekday.';
            return;
        }

        scannerTextbox.value = scanner;

        // Determine the column to search based on Weekday
        const weekdayColumnMap = {
            "Monday": "MON",
            "Tuesday": "TUE",
            "Wednesday": "WED",
            "Thursday": "THU",
            "Friday": "FRI"
        };

        const column = weekdayColumnMap[weekdaySelect];
        if (!column) {
            resultDiv.innerHTML = 'Invalid Weekday selected.';
            return;
        }

        // Use full Scanner string (e.g., "Scanner M")
        const scannerUpper = scanner.toUpperCase();

        // Search in cupboardData for wards where the specified column has the scanner
        const matchedWards = cupboardData
            .filter(row => row[column] && row[column].toUpperCase() === scannerUpper)
            .map(row => row.ward)
            .filter(ward => ward) // Remove empty wards
            .sort(sortWardsDesc);

        if (matchedWards.length > 0) {
            // Remove duplicates
            const uniqueWards = [...new Set(matchedWards)];
            // Apply custom sort
            uniqueWards.sort(sortWardsDesc);
            // Create accordion-style details elements
            let wardListHTML = `<h3>Wards with ${scanner} on ${weekdaySelect}:</h3>`;
            uniqueWards.forEach(ward => {
                const found = cupboardData.find(row => row.ward === ward);
                if (found) {
                    wardListHTML += `
                        <details>
                            <summary>${ward}</summary>
                            <div class="wardDropdown">
                                <p class="ward-title">Ward: ${found.ward}</p>
                                <p class="location-label">Ward Stock Cupboard Location:</p>
                                <p class="location-value">${found.wardStockCupboardLocation || 'N/A'}</p>
                                <p class="location-label">Fridge Location:</p>
                                <p class="location-value">${found.fridgeLocation || 'N/A'}</p>
                                <p class="location-label">Concentrated Electrolyte Cupboard Location:</p>
                                <p class="location-value">${found.concentratedElectrolyteCupboardLocation || 'N/A'}</p>
                                ${found.remark && found.remark.trim() !== '' ? `
                                    <p class="location-label">Remark:</p>
                                    <p class="location-value">${found.remark}</p>
                                ` : ''}
                            </div>
                        </details>
                    `;
                }
            });
            resultDiv.innerHTML = wardListHTML;

            // Enforce single-open accordion behavior
            document.querySelectorAll('#dutyQueryResult details').forEach(details => {
                details.addEventListener('toggle', function() {
                    if (this.open) {
                        document.querySelectorAll('#dutyQueryResult details').forEach(d => {
                            if (d !== this) d.open = false;
                        });
                    }
                });
            });
        } else {
            resultDiv.innerHTML = `No wards found with ${scanner} on ${weekdaySelect}.`;
        }
    }

    // Function to auto-select the current weekday
    async function autoSelectWeekday() {
        const currentDate = new Date();
        const weekdayNumber = currentDate.getDay(); // Sunday - Saturday : 0 - 6
        const weekdayMap = {
            1: "Monday",
            2: "Tuesday",
            3: "Wednesday",
            4: "Thursday",
            5: "Friday",
            6: "Saturday",
            0: "Sunday"
        };
        const currentWeekday = weekdayMap[weekdayNumber] || "Monday";
        document.getElementById('weekdaySelect').value = currentWeekday;
    }

let codeReader;
let scanning = false;
let videoStream = null; 
function startScanner() {
    const modal = document.getElementById('scannerModal');
    const video = document.getElementById('scanner-video');

    // 顯示掃描器模態框
    modal.style.display = 'block';

    // 僅在按下按鈕時請求鏡頭權限
    if (!videoStream) {
        navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "environment", // 後置鏡頭
                width: { ideal: 1920 }, // 設置高解析度
                height: { ideal: 1080 },
                advanced: [{ focusMode: "continuous" }] // 使用連續對焦
            }
        })
        .then((stream) => {
            videoStream = stream;
            video.srcObject = stream;
            video.setAttribute('playsinline', true); // 防止 iOS 全屏模式
            video.play();
            scanning = true;
            scanBarcodes(); // 開始條碼掃描
            autoRestartScanner();
        })
        .catch((error) => {
            console.error('Camera access denied or error:', error);
            alert('Camera access is required to scan barcodes.');
        });
    } else {
        video.srcObject = videoStream;
        video.play();
        scanning = true;
        scanBarcodes(); // 開始條碼掃描
    }
}


async function scanBarcodes() {
    const video = document.getElementById('scanner-video');
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');

    scanning = true; // 確保 scanning 始終為 true

    async function tick() {
        if (!scanning) return; // 僅在 scanning 為 true 時繼續執行

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
                // QR Code 處理
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const qrResult = jsQR(imageData.data, imageData.width, imageData.height);
                if (qrResult) {
                    console.log('QR Code detected:', qrResult.data);
                    const qrContent = normalizeBarcode(qrResult.data.trim());
                    handleItemCode(qrContent);
                    return; // 停止當前處理，但繼續掃描
                }

                // Data Matrix 和其他條碼處理
                const source = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
                const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(source));
                const reader = new ZXing.MultiFormatReader();

                const hints = new Map();
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.DATA_MATRIX,
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.UPC_A,
                    ZXing.BarcodeFormat.PZN
                ]);

                try {
                    const result = reader.decode(binaryBitmap, hints);
                    if (result) {
                        const scannedText = normalizeBarcode(result.text.trim());
                        const format = result.getBarcodeFormat();
                        console.log('Barcode detected:', format, scannedText);
                        processScannedBarcode(format, scannedText); // 繼續處理條碼
                        return; // 停止當前處理，但繼續掃描
                    }
                } catch (readerError) {
                    if (readerError.name !== 'NotFoundException') {
                        console.error('ZXing reader error:', readerError);
                    }
                }
            } catch (error) {
                console.error('General scanning error:', error);
            }
        }

        if (scanning) {
            requestAnimationFrame(tick); // 持續掃描
        }
    }

    tick(); // 啟動掃描循環
}

function processScannedBarcode(format, scannedText) {
    if (format === ZXing.BarcodeFormat.DATA_MATRIX) {
        handleDataMatrix(scannedText);
    } else if (format === ZXing.BarcodeFormat.PZN) {
        const pznMatch = scannedText.match(/PZN[-\s]*(\d+)/i);
        if (pznMatch) {
            const pznCode = pznMatch[1];
            handleItemCode(pznCode);
        }
    } else if (format === ZXing.BarcodeFormat.UPC_A && /^\d{12}$/.test(scannedText)) {
        handleItemCode(scannedText);
    } else {
        handleItemCode(scannedText);
    }

    // 確保掃描循環繼續運行
    requestAnimationFrame(scanBarcodes);
}

function autoRestartScanner() {
    setInterval(() => {
        if (!scanning) {
            resetScanner();
        }
    }, 10000); // 每隔60秒重啟一次掃描
}

// 增強靈敏度

function closeScanner() {
    const modal = document.getElementById('scannerModal');
    const video = document.getElementById('scanner-video');
    
    // 停止掃描
    scanning = false;

    // 停止視頻流
    if (video.srcObject) {
        const tracks = video.srcObject.getTracks();
        tracks.forEach(track => track.stop());
        video.srcObject = null;
    }

    // 隱藏模態框
    modal.style.display = 'none';
}


// 顯示 Loading
function showLoading() {
    const modal = document.createElement('div');
    modal.id = 'loadingModal';
    modal.innerHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-4 rounded-lg shadow-lg text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-2">分析條碼中...</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// 隱藏 Loading
function hideLoading() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
        modal.remove();
    }
}

// 處理 DataMatrix
async function handleDataMatrix(scannedText) {
    try {
        console.log('Analyzing DataMatrix:', scannedText);

        if (scannedText.startsWith('01')) {
            const match = scannedText.match(/01(\d+?)(?=17|$)/);
            if (match && match[1]) {
                const gtinPart = match[1];
                console.log('Extracted GTIN from GS1:', gtinPart);
                const itemCode = productIdMap.get(gtinPart);

                if (itemCode) {
                    console.log('Found item code:', itemCode);
                    handleItemCode(itemCode);
                    return;
                } else {
                    alert(`條碼 ${gtinPart} (${scannedText}) 未在系統中登記，請檢查條碼或聯繫支持。`);
                }
            }
        } else {
            const gtinMatch = scannedText.match(/GTIN[:\s]*(\d+)/i);
            if (gtinMatch) {
                const gtin = gtinMatch[1];
                console.log('Extracted GTIN from text:', gtin);
                const itemCode = productIdMap.get(gtin);

                if (itemCode) {
                    console.log('Found item code:', itemCode);
                    handleItemCode(itemCode);
                    return;
                } else {
                    alert(`條碼 ${gtin} (${scannedText}) 未在系統中登記，請檢查條碼或聯繫支持。`);
                }
            } else {
                alert(`無法識別的 DataMatrix 格式: ${scannedText}，請檢查條碼或聯繫支持。`);
                console.log('Unrecognized DataMatrix format:', scannedText);
            }
        }
    } catch (error) {
        console.error('DataMatrix 分析錯誤:', error);
        alert('分析條碼時發生錯誤，請重試或聯繫支持。');
    }
}

function handleItemCode(itemCode) {
    if (!itemCode) {
        return;
    }

    const selectedWard = document.getElementById('wardSelect').value;
    if (!selectedWard) {
        displayScanResult('請先選擇病房', false);
        return;
    }

    console.log('處理商品代碼:', itemCode);

    // 查找物品位置信息
    const itemInfo = data.find(row => 
        row.ward === selectedWard && 
        row.itemCode.toString() === itemCode.toString()
    );

    if (itemInfo) {
        // 組裝文字結果
        const resultHTML = `
            <p><span class="highlight">Ward:</span> ${itemInfo.ward}</p>
            <p><span class="highlight">Item Code:</span> ${itemInfo.itemCode}</p>
            <p><span class="highlight">Description:</span> ${itemDescriptions.get(itemCode) || '無描述'}</p>
            <p><span class="highlight">Location:</span> ${itemInfo.location}</p>
        `;

        // 判斷是否需要生成 QR Code
        if (
            (selectedWard.toUpperCase() === 'B6' || selectedWard.toUpperCase() === 'D6') && 
            (itemInfo.location.startsWith('***E') || itemInfo.location.startsWith('**E'))
        ) {
            displayScanResultWithQrCode(resultHTML, itemCode, true);
        } else {
            displayScanResult(resultHTML, true);
        }

        // 自動過濾並顯示結果
        document.getElementById('itemCodeFilter').value = itemCode;
        filterItemCodes();
    } else {
        // 顯示找不到的訊息，但不應停止掃描
        displayScanResult(`此物品 (${itemCode}) 未在系統中登記`, false);
    }

    // 不重置掃描器，保持連續掃描狀態
}

// 新增重置掃描器函數
function resetScanner() {
    // 停止視頻流
    const video = document.getElementById('scanner-video');
    if (video.srcObject) {
        const tracks = video.srcObject.getTracks();
        tracks.forEach(track => track.stop());
    }
    scanning = false; // 停止掃描循環
}

function displayScanResultWithQrCode(message, itemCode, isSuccess, autoReset = true) {
    const resultDisplay = document.querySelector('.scan-result-display');

    if (resultDisplay) {
        resultDisplay.style.display = 'block';

        // 構建顯示內容，將提示文字移到二維碼上方
        const displayContent = `
            <div class="result-container">
                <!-- QR Code 區域 -->
                <div class="qr-code-section">
                    <p class="qr-reminder">請掃瞄此二維碼打開所屬藥格</p>
                    <canvas id="scan-result-qr" width="150" height="150"></canvas>
                </div>
                <!-- 文字結果區域 -->
                <div class="text-result-section">
                    ${message}
                </div>
            </div>
        `;

        resultDisplay.innerHTML = displayContent;

        // 生成 QR Code
        const qrCanvas = document.getElementById('scan-result-qr');
        if (qrCanvas) {
            try {
                new QRious({
                    element: qrCanvas,
                    value: itemCode,
                    size: 150,
                    level: 'H'
                });
            } catch (error) {
                console.error('QR Code generation error:', error);
            }
        }

        // 自動重置掃描器
        if (autoReset) {
            const resetDelay = isSuccess ? 2000 : 1500;
            setTimeout(() => {
                resetScanner();
            }, resetDelay);
        }
    }
}
function displayScanResult(message, isSuccess, autoReset = true) {
    const resultDisplay = document.querySelector('.scan-result-display');

    if (resultDisplay) {
        resultDisplay.style.display = 'block';

        // 根據是否成功切換樣式
        const messageStyle = `
            color: ${isSuccess ? '#4CAF50' : '#f44336'}; 
            font-weight: ${isSuccess ? 'normal' : 'bold'}; 
            text-align: ${isSuccess ? 'left' : 'center'};
        `;

        // 構建顯示內容
        const displayContent = `
            <div class="text-result-section" style="${messageStyle}">
                ${message}
            </div>
        `;

        resultDisplay.innerHTML = displayContent;

        // 自動重置掃描器
        if (autoReset) {
            const resetDelay = isSuccess ? 2000 : 1500;
            setTimeout(() => {
                resetScanner();
            }, resetDelay);
        }
    }
}

</script>
</body>
</html>